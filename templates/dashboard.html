{% extends "base.html" %}

{% block head %}
<style>
    .dashboard-container {
        width: 100vw;
        height: 100vh;
        background: var(--primary);
        color: var(--secondary);
        overflow: hidden;
        position: relative;
    }
    
    .dashboard-header {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 100;
    }
    
    .dashboard-title {
        font-size: 2rem;
        margin-bottom: 0.5rem;
        color: var(--accent);
    }
    
    .dashboard-subtitle {
        font-size: 1rem;
        opacity: 0.7;
    }
    
    .viz-container {
        width: 100%;
        height: 100%;
        position: relative;
    }
    
    .mode-toggle {
        position: absolute;
        top: 80px;
        right: 20px;
        z-index: 100;
        display: flex;
        gap: 10px;
        background: rgba(0, 0, 0, 0.8);
        padding: 8px;
        border-radius: 4px;
    }
    
    .mode-btn {
        background: none;
        border: 1px solid var(--accent);
        color: var(--accent);
        padding: 8px 16px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .mode-btn.active {
        background: var(--accent);
        color: var(--primary);
    }
    
    .mode-btn:hover {
        background: var(--accent);
        color: var(--primary);
    }
    
    #wordcloud {
        width: 100%;
        height: 100%;
    }
    
    .stats-overlay {
        position: absolute;
        bottom: 20px;
        left: 20px;
        font-family: 'JetBrains Mono', monospace;
        font-size: 12px;
        opacity: 0.7;
    }
    
    .live-indicator {
        position: absolute;
        top: 80px;
        left: 20px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        opacity: 0.8;
    }
    
    .live-dot {
        width: 8px;
        height: 8px;
        background: var(--accent);
        border-radius: 50%;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.3; }
    }
    
    .word-node {
        position: absolute;
        color: var(--secondary);
        font-size: 16px;
        transition: all 0.5s ease;
        cursor: pointer;
        user-select: none;
    }
    
    .word-node:hover {
        color: var(--accent);
        transform: scale(1.2);
    }
    
    .connection-line {
        position: absolute;
        height: 1px;
        background: rgba(0, 255, 136, 0.2);
        transform-origin: left center;
        transition: opacity 0.5s ease;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1 class="dashboard-title glitch">COLLECTIVE MIND</h1>
        <p class="dashboard-subtitle mono">Live visualization of participant thoughts</p>
    </div>
    
    <div class="live-indicator">
        <div class="live-dot"></div>
        <span class="mono">LIVE</span>
    </div>
    
    <div class="mode-toggle">
        <button class="mode-btn active" onclick="setMode('wordcloud')">Words</button>
        <button class="mode-btn" onclick="setMode('network')">Network</button>
        <button class="mode-btn" onclick="setMode('flow')">Flow</button>
    </div>
    
    <div class="viz-container">
        <div id="wordcloud"></div>
    </div>
    
    <div class="stats-overlay">
        <div>Thoughts collected: <span id="thoughtCount">0</span></div>
        <div>Active connections: <span id="connectionCount">0</span></div>
        <div>Last update: <span id="lastUpdate">--:--</span></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
    let currentMode = 'wordcloud';
    let wordData = {};
    let thoughtCount = 0;
    
    // Initialize visualization
    initDashboard();
    
    function initDashboard() {
        loadWordcloud();
        
        // Listen for real-time updates
        socket.on('new_feedback', function(data) {
            thoughtCount++;
            document.getElementById('thoughtCount').textContent = thoughtCount;
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            
            // Add new words to visualization
            addNewWords(data.content);
        });
        
        // Refresh data every 30 seconds
        setInterval(loadWordcloud, 30000);
    }
    
    function loadWordcloud() {
        fetch('/api/wordcloud')
            .then(response => response.json())
            .then(data => {
                wordData = data;
                thoughtCount = Object.values(data).reduce((a, b) => a + b, 0);
                document.getElementById('thoughtCount').textContent = thoughtCount;
                
                if (currentMode === 'wordcloud') {
                    renderWordcloud();
                } else if (currentMode === 'network') {
                    renderNetwork();
                } else if (currentMode === 'flow') {
                    renderFlow();
                }
            });
    }
    
    function setMode(mode) {
        currentMode = mode;
        
        // Update button states
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // Clear and render new visualization
        document.getElementById('wordcloud').innerHTML = '';
        
        if (mode === 'wordcloud') {
            renderWordcloud();
        } else if (mode === 'network') {
            renderNetwork();
        } else if (mode === 'flow') {
            renderFlow();
        }
    }
    
    function renderWordcloud() {
        const container = document.getElementById('wordcloud');
        const words = Object.entries(wordData);
        
        if (words.length === 0) return;
        
        const maxFreq = Math.max(...Object.values(wordData));
        
        words.forEach(([word, freq]) => {
            const wordEl = document.createElement('div');
            wordEl.className = 'word-node';
            wordEl.textContent = word;
            
            const size = 12 + (freq / maxFreq) * 48;
            const x = Math.random() * (window.innerWidth - 200);
            const y = Math.random() * (window.innerHeight - 100) + 100;
            
            wordEl.style.cssText = `
                left: ${x}px;
                top: ${y}px;
                font-size: ${size}px;
                opacity: ${0.3 + (freq / maxFreq) * 0.7};
            `;
            
            container.appendChild(wordEl);
            
            // Animate in
            setTimeout(() => {
                wordEl.style.transform = 'scale(1)';
            }, Math.random() * 1000);
        });
    }
    
    function renderNetwork() {
        const container = document.getElementById('wordcloud');
        const words = Object.entries(wordData).slice(0, 15); // Limit for performance
        
        if (words.length === 0) return;
        
        const centerX = window.innerWidth / 2;
        const centerY = window.innerHeight / 2;
        const maxFreq = Math.max(...Object.values(wordData));
        
        // Create center node
        const centerNode = document.createElement('div');
        centerNode.className = 'word-node';
        centerNode.textContent = 'COLLECTIVE';
        centerNode.style.cssText = `
            left: ${centerX - 50}px;
            top: ${centerY - 15}px;
            font-size: 32px;
            color: var(--accent);
            font-weight: bold;
        `;
        container.appendChild(centerNode);
        
        // Create word nodes in multiple rings
        words.forEach(([word, freq], index) => {
            const ring = Math.floor(index / 5) + 1; // Multiple rings
            const angleOffset = ring * 0.3; // Offset each ring
            const radius = Math.min(centerX, centerY) * (0.3 + ring * 0.2);
            const angle = (index / 5) * 2 * Math.PI + angleOffset;
            
            const x = centerX + Math.cos(angle) * radius;
            const y = centerY + Math.sin(angle) * radius;
            
            const wordEl = document.createElement('div');
            wordEl.className = 'word-node';
            wordEl.textContent = word;
            wordEl.style.cssText = `
                left: ${x - word.length * 4}px;
                top: ${y - 10}px;
                font-size: ${16 + (freq / maxFreq) * 24}px;
                opacity: ${0.6 + (freq / maxFreq) * 0.4};
            `;
            
            container.appendChild(wordEl);
            
            // Create connections to center and nearby nodes
            const line = document.createElement('div');
            line.className = 'connection-line';
            const length = Math.sqrt((x - centerX) ** 2 + (y - centerY) ** 2);
            const lineAngle = Math.atan2(y - centerY, x - centerX);
            
            line.style.cssText = `
                left: ${centerX}px;
                top: ${centerY}px;
                width: ${length}px;
                transform: rotate(${lineAngle}rad);
                opacity: ${0.2 + (freq / maxFreq) * 0.3};
            `;
            
            container.appendChild(line);
            
            // Connect to nearby nodes
            if (index > 0 && Math.random() < 0.4) {
                const prevIndex = index - 1;
                const prevRing = Math.floor(prevIndex / 5) + 1;
                const prevAngleOffset = prevRing * 0.3;
                const prevRadius = Math.min(centerX, centerY) * (0.3 + prevRing * 0.2);
                const prevAngle = (prevIndex / 5) * 2 * Math.PI + prevAngleOffset;
                
                const prevX = centerX + Math.cos(prevAngle) * prevRadius;
                const prevY = centerY + Math.sin(prevAngle) * prevRadius;
                
                const connectLine = document.createElement('div');
                connectLine.className = 'connection-line';
                const connectLength = Math.sqrt((x - prevX) ** 2 + (y - prevY) ** 2);
                const connectAngle = Math.atan2(y - prevY, x - prevX);
                
                connectLine.style.cssText = `
                    left: ${prevX}px;
                    top: ${prevY}px;
                    width: ${connectLength}px;
                    transform: rotate(${connectAngle}rad);
                    opacity: 0.1;
                    background: rgba(0, 255, 136, 0.3);
                `;
                
                container.appendChild(connectLine);
            }
        });
        
        document.getElementById('connectionCount').textContent = container.querySelectorAll('.connection-line').length;
    }
    
    function renderFlow() {
        const container = document.getElementById('wordcloud');
        const words = Object.entries(wordData);
        const maxFreq = Math.max(...Object.values(wordData));
        
        words.forEach(([word, freq], index) => {
            setTimeout(() => {
                const wordEl = document.createElement('div');
                wordEl.className = 'word-node';
                wordEl.textContent = word;
                
                const startX = Math.random() * window.innerWidth;
                const endX = Math.random() * window.innerWidth;
                const duration = 8000 + Math.random() * 4000;
                const size = 24 + (freq / maxFreq) * 48; // Much bigger words
                
                wordEl.style.cssText = `
                    left: ${startX}px;
                    top: ${window.innerHeight + 50}px;
                    font-size: ${size}px;
                    transition: all ${duration}ms ease-out;
                    opacity: ${0.7 + (freq / maxFreq) * 0.3};
                    font-weight: ${freq > maxFreq * 0.5 ? 'bold' : 'normal'};
                `;
                
                container.appendChild(wordEl);
                
                setTimeout(() => {
                    wordEl.style.left = endX + 'px';
                    wordEl.style.top = '-100px';
                    wordEl.style.opacity = '0';
                    wordEl.style.transform = `rotate(${Math.random() * 20 - 10}deg) scale(0.8)`;
                }, 100);
                
                setTimeout(() => {
                    wordEl.remove();
                }, duration + 100);
            }, index * 300); // Faster spawn rate
        });
    }
    
    function addNewWords(content) {
        const words = content.split(' ').slice(0, 5);
        const container = document.getElementById('wordcloud');
        
        if (currentMode === 'flow') {
            words.forEach((word, index) => {
                setTimeout(() => {
                    const wordEl = document.createElement('div');
                    wordEl.className = 'word-node';
                    wordEl.textContent = word;
                    wordEl.style.cssText = `
                        left: ${Math.random() * window.innerWidth}px;
                        top: ${window.innerHeight}px;
                        font-size: 36px;
                        color: var(--accent);
                        transition: all 4s ease-out;
                        font-weight: bold;
                        text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
                    `;
                    
                    container.appendChild(wordEl);
                    
                    setTimeout(() => {
                        wordEl.style.top = '-100px';
                        wordEl.style.opacity = '0';
                        wordEl.style.transform = `rotate(${Math.random() * 30 - 15}deg)`;
                    }, 100);
                    
                    setTimeout(() => {
                        wordEl.remove();
                    }, 4100);
                }, index * 200);
            });
        } else if (currentMode === 'network') {
            // Add pulsing effect to existing network
            const existingWords = container.querySelectorAll('.word-node');
            existingWords.forEach(wordEl => {
                wordEl.style.animation = 'pulse 1s ease-in-out';
                setTimeout(() => {
                    wordEl.style.animation = '';
                }, 1000);
            });
        }
    }
</script>
{% endblock %}
